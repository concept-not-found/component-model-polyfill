<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>module linking polyfill demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.skypack.dev/codemirror@v5.65.0/lib/codemirror.css"
    />
    <style>
      html {
        box-sizing: border-box;
      }

      *,
      *:before,
      *:after {
        box-sizing: inherit;
      }

      body {
        background-color: lightgray;
        font-family: monospace;
        height: 100vh;
        width: 100vw;
      }

      html,
      body {
        margin: 0;
        padding: 0;
      }

      main {
        padding-left: 5px;
        padding-right: 5px;
        height: 100%;
        width: 100%;
        display: grid;

        grid-template-rows:
          min-content min-content min-content min-content minmax(25%, 1fr)
          min-content minmax(25%, 1fr);
        grid-template-columns: 50% 50%;
        grid-gap: 5px;
      }

      .span-row {
        grid-column-start: 1;
        grid-column-end: 3;
      }

      .CodeMirror {
        height: 100%;
      }

      .subtitle {
        margin-top: 10px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/wabt@1.0.25/index.js"></script>
  </head>

  <body>
    <main>
      <h1 class="span-row">module linking polyfill demo</h1>
      <p class="span-row">
        This is a work in progress polyfill for
        <a href="https://webassembly.org/">WebAssembly</a>
        <a href="https://github.com/WebAssembly/module-linking"
          >module linking</a
        >.
      </p>
      <p class="span-row">
        <label>
          Examples:
          <select id="examples"></select
        ></label>
      </p>

      <span class="subtitle">WebAssembly Text</span>
      <span class="subtitle">WebAssembly console</span>
      <div id="wat"></div>
      <div id="wat-console"></div>
      <span class="subtitle">JavaScript (only console.log() is supported)</span>
      <span class="subtitle">JavaScript console</span>
      <div id="js"></div>
      <div id="js-console"></div>
    </main>

    <script type="module">
      import CodeMirror from 'https://cdn.skypack.dev/pin/codemirror@v5.65.0-PQxIsYN0IQoqvGScHYR5/mode=imports,min/unoptimized/lib/codemirror.js'
      import 'https://cdn.skypack.dev/pin/codemirror@v5.65.0-PQxIsYN0IQoqvGScHYR5/mode=imports,min/unoptimized/mode/wast/wast.js'
      import 'https://cdn.skypack.dev/pin/codemirror@v5.65.0-PQxIsYN0IQoqvGScHYR5/mode=imports,min/unoptimized/mode/javascript/javascript.js'
      import debounce from 'https://cdn.skypack.dev/pin/debounce@v1.2.1-nsljQIXDuyHmm6xBMrgd/mode=imports,min/optimized/debounce.js'
      import Index from './index.js'
      import examples from './examples.js'

      for (const { name } of examples) {
        const option = document.createElement('option')
        option.value = name
        option.text = name
        document.getElementById('examples').add(option)
      }

      document
        .getElementById('examples')
        .addEventListener('change', ({ target: { value } }) => {
          const { watSource, jsSource } = examples.find(
            ({ name }) => name === value
          )
          js.setValue(jsSource)
          wat.setValue(watSource)
        })
      const wat = CodeMirror(document.getElementById('wat'), {
        value: examples[0].watSource,
        mode: 'wast',
        lineNumbers: true,
        viewportMargin: Infinity,
      })
      const watConsole = CodeMirror(document.getElementById('wat-console'), {
        value: ``,
        lineNumbers: true,
        viewportMargin: Infinity,
        readOnly: true,
        cursorHeight: 0,
      })
      const js = CodeMirror(document.getElementById('js'), {
        value: examples[0].jsSource,
        mode: 'javascript',
        lineNumbers: true,
        viewportMargin: Infinity,
      })
      const jsConsole = CodeMirror(document.getElementById('js-console'), {
        value: ``,
        lineNumbers: true,
        viewportMargin: Infinity,
        readOnly: true,
        cursorHeight: 0,
      })

      const fakeConsole = {
        log(...messages) {
          jsConsole.replaceRange(
            `${messages.join(' ')}\n`,
            CodeMirror.Pos(jsConsole.lastLine())
          )
        },
      }

      const wabt = await WabtModule()
      const { transformWat, execJs } = Index(wabt, fakeConsole)
      let config
      function onWatChange() {
        try {
          watConsole.setValue('')
          config = transformWat(wat.getValue())
          watConsole.setValue(JSON.stringify(config, null, 2))
        } catch (error) {
          watConsole.setValue(String(error))
        }
        onJsChange()
      }
      onWatChange()
      wat.on('change', debounce(onWatChange, 200))

      function onJsChange() {
        try {
          jsConsole.setValue('')
          execJs(js.getValue(), config)
        } catch (error) {
          jsConsole.setValue(String(error))
        }
      }
      onJsChange()

      js.on('change', debounce(onJsChange, 200))
    </script>
  </body>
</html>
